---
title: "OpenCode 配置文件修复指南：从 JSON 错误到 LSP 配置"
date: "2026-02-14T21:22:00"
excerpt: "本文详细记录了修复 OpenCode 配置文件 (opencode.json) 的过程，包括 JSON 转义错误、无效配置键和 LSP 配置格式问题的解决方案。"
tags: [OpenCode, JSON, LSP, Windows, 配置]
author: "cjf"
---

# OpenCode 配置文件修复指南：从 JSON 错误到 LSP 配置

## 引言

在使用 OpenCode 过程中，配置文件 `opencode.json` 的错误是常见的问题。本文将详细记录一次完整的配置文件修复过程，包括遇到的各种错误及其解决方案。

## 问题描述

在 Windows 系统上运行 OpenCode 时，遇到了配置文件解析错误：

```bash
PS C:\Users\14023\WebstormProjects\my-blog> opencode --hostname 127.0.0.1 --port 4097 --continue
Error: Config file at C:\Users\14023\.config\opencode\opencode.json is not valid JSON(C):
--- JSONC Input ---
...
--- Errors ---
InvalidEscapeCharacter at line 108, column 19
```

## 错误原因分析

经过分析，发现了三个主要问题：

### 1. JSON 转义问题
Windows 路径使用了反斜杠 `\`，在 JSON 中需要转义为 `\` 或使用正斜杠 `/`。

### 2. 无效的配置键
`blog` 不是 OpenCode 支持的标准配置键，导致 `"Unrecognized key: \"blog\""` 错误。

### 3. LSP 配置格式错误
使用了错误的属性名（`servers`、`filetypes`、`rootPatterns`），这些都不是 OpenCode 支持的 LSP 配置格式。

## 修复过程

### 第一步：修复 Windows 路径

将 Windows 路径从反斜杠改为正斜杠：

```json
// 错误
"template": "@blog-writer ... C:\Users\14023\WebstormProjects\..."

// 正确
"template": "@blog-writer ... C:/Users/14023/WebstormProjects/..."
```

### 第二步：移除无效配置

删除 `blog` 配置部分：

```json
// 删除以下整个部分
"blog": {
  "defaultAuthor": "cjf",
  "outputPath": "C:/Users/14023/WebstormProjects/my-blog/content/blog",
  ...
}
```

### 第三步：修复 LSP 配置格式

这是最关键的部分。根据 OpenCode 官方文档，正确的 LSP 配置格式如下：

#### ❌ 错误配置

```json
"lsp": {
  "enabled": true,
  "servers": {
    "typescript": {
      "command": ["typescript-language-server", "--stdio"],
      "filetypes": ["typescript", "typescriptreact", "javascript", "javascriptreact"],
      "rootPatterns": ["package.json", "tsconfig.json", "jsconfig.json"]
    }
  }
}
```

**问题：**
- 使用了 `servers` 包装层（不存在）
- 使用了 `filetypes`（应该是 `extensions`）
- 使用了 `rootPatterns`（不存在）
- 使用了 `enabled`（应该是 `disabled`）

#### ✅ 正确配置

```json
"lsp": {
  "typescript": {
    "command": ["typescript-language-server", "--stdio"],
    "extensions": [".ts", ".tsx", ".js", ".jsx"]
  },
  "rust": {
    "command": ["rust-analyzer"],
    "extensions": [".rs"]
  },
  "python": {
    "command": ["pylsp"],
    "extensions": [".py"]
  },
  "go": {
    "command": ["gopls"],
    "extensions": [".go"]
  },
  "bash": {
    "command": ["bash-language-server", "start"],
    "extensions": [".sh", ".bash"]
  }
}
```

**关键区别：**
1. 不需要 `servers` 包装层，直接在 `lsp` 下配置各个服务器
2. 使用 `extensions` 指定文件扩展名，而不是 `filetypes`
3. 不需要 `rootPatterns`
4. 不需要 `enabled`，默认启用所有配置的服务器

## 最终配置文件

修复后的完整配置文件结构：

```json
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "plan": {
      "model": "kimi-for-coding/kimi-k2-thinking"
    }
  },
  "default_agent": "plan",
  "instructions": [
    "~/.config/opencode/AGENTS.md"
  ],
  "mcp": {
    "context7": { ... },
    "github": { ... },
    "gh_grep": { ... },
    "filesystem": { ... },
    "sequential_thinking": { ... },
    "memory": { ... },
    "everything": { ... }
  },
  "command": {
    "arch": { ... },
    "review": { ... },
    "test": { ... },
    "refactor": { ... },
    "explore": { ... },
    "docs": { ... },
    "save-blog": { ... },
    "sb": { ... }
  },
  "plugin": [
    "oh-my-opencode@latest"
  ],
  "lsp": {
    "typescript": {
      "command": ["typescript-language-server", "--stdio"],
      "extensions": [".ts", ".tsx", ".js", ".jsx"]
    },
    "rust": {
      "command": ["rust-analyzer"],
      "extensions": [".rs"]
    },
    "python": {
      "command": ["pylsp"],
      "extensions": [".py"]
    },
    "go": {
      "command": ["gopls"],
      "extensions": [".go"]
    },
    "bash": {
      "command": ["bash-language-server", "start"],
      "extensions": [".sh", ".bash"]
    }
  }
}
```

## 验证修复

修复完成后，运行以下命令验证：

```bash
opencode --hostname 127.0.0.1 --port 4097 --continue
```

如果没有错误提示，说明配置已正确修复。

## 总结

修复 OpenCode 配置文件时需要注意：

1. **Windows 路径**：使用正斜杠 `/` 或双反斜杠 `\`
2. **配置键名**：确保使用 OpenCode 支持的标准键
3. **LSP 配置**：使用正确的属性名（`extensions` 而非 `filetypes`）
4. **查阅文档**：遇到问题时，参考官方文档或 Context7 知识库

## 参考资源

- [OpenCode 官方文档](https://opencode.ai)
- [OpenCode LSP 配置文档](https://github.com/anomalyco/opencode/blob/dev/packages/web/src/content/docs/lsp.mdx)
- Context7 知识库：`/anomalyco/opencode`

---

*本文记录了实际修复过程中的问题和解决方案，希望对你有所帮助。*
